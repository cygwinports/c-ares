--- origsrc/c-ares-1.12.0/ares_init.c	2016-09-27 03:33:06.000000000 -0500
+++ src/c-ares-1.12.0/ares_init.c	2017-06-18 14:21:01.904438000 -0500
@@ -86,7 +86,7 @@ static int sortlist_alloc(struct apatter
                           struct apattern *pat);
 static int ip_addr(const char *s, ssize_t len, struct in_addr *addr);
 static void natural_mask(struct apattern *pat);
-#if !defined(WIN32) && !defined(WATT32) && \
+#if defined(__CYGWIN__) || !defined(WIN32) && !defined(WATT32) && \
     !defined(ANDROID) && !defined(__ANDROID__) && !defined(CARES_USE_LIBRESOLV)
 static int config_domain(ares_channel channel, char *str);
 static int config_lookup(ares_channel channel, const char *str,
@@ -558,7 +558,7 @@ static int init_by_environment(ares_chan
   return ARES_SUCCESS;
 }
 
-#ifdef WIN32
+#if defined(WIN32) || defined(__CYGWIN__)
 /*
  * get_REG_SZ()
  *
@@ -910,8 +910,8 @@ static int get_DNS_NetworkParams(char **
     /* Validate converting textual address to binary format. */
     if (ares_inet_pton(AF_INET, txtaddr, &namesrvr.addrV4) == 1)
     {
-      if ((namesrvr.addrV4.S_un.S_addr == INADDR_ANY) ||
-          (namesrvr.addrV4.S_un.S_addr == INADDR_NONE))
+      if ((namesrvr.addrV4.s_addr == INADDR_ANY) ||
+          (namesrvr.addrV4.s_addr == INADDR_NONE))
         continue;
     }
     else if (ares_inet_pton(AF_INET6, txtaddr, &namesrvr.addrV6) == 1)
@@ -939,6 +939,7 @@ done:
   return 1;
 }
 
+#ifndef __CYGWIN__
 /*
  * get_DNS_AdaptersAddresses()
  *
@@ -1020,8 +1021,8 @@ static int get_DNS_AdaptersAddresses(cha
 
       if (namesrvr.sa->sa_family == AF_INET)
       {
-        if ((namesrvr.sa4->sin_addr.S_un.S_addr == INADDR_ANY) ||
-            (namesrvr.sa4->sin_addr.S_un.S_addr == INADDR_NONE))
+        if ((namesrvr.sa4->sin_addr.s_addr == INADDR_ANY) ||
+            (namesrvr.sa4->sin_addr.s_addr == INADDR_NONE))
           continue;
         if (! ares_inet_ntop(AF_INET, &namesrvr.sa4->sin_addr,
                              txtaddr, sizeof(txtaddr)))
@@ -1055,6 +1056,7 @@ done:
 
   return 1;
 }
+#endif
 
 /*
  * get_DNS_Windows()
@@ -1082,9 +1084,11 @@ static int get_DNS_Windows(char **outptr
   if (get_DNS_NetworkParams(outptr))
     return 1;
 
+#ifndef __CYGWIN__
   /* Try using IP helper API GetAdaptersAddresses() */
   if (get_DNS_AdaptersAddresses(outptr))
     return 1;
+#endif
 
   /* Fall-back to registry information */
   return get_DNS_Registry(outptr);
@@ -1101,7 +1105,7 @@ static int init_by_resolv_conf(ares_chan
   struct server_state *servers = NULL;
   struct apattern *sortlist = NULL;
 
-#ifdef WIN32
+#if defined(WIN32) && !defined(__CYGWIN__)
 
   if (channel->nservers > -1)  /* don't override ARES_OPT_SERVER */
      return ARES_SUCCESS;
@@ -1286,6 +1290,18 @@ static int init_by_resolv_conf(ares_chan
       }
       fclose(fp);
     }
+#ifdef __CYGWIN__
+    else if (get_DNS_Windows(&line)) {
+      status = config_nameserver(&servers, &nservers, line);
+      if (status == ARES_SUCCESS) {
+        channel->lookups = ares_strdup("b");
+        status = ARES_EOF;
+      } else
+        /* Catch the case when all the above checks fail (which happens when there
+           is no network card or the cable is unplugged) */
+        status = ARES_EFILE;
+    }
+#endif
     else {
       error = ERRNO;
       switch(error) {
@@ -1569,7 +1585,7 @@ static int init_by_defaults(ares_channel
   return rc;
 }
 
-#if !defined(WIN32) && !defined(WATT32) && \
+#if defined(__CYGWIN__) || !defined(WIN32) && !defined(WATT32) && \
     !defined(ANDROID) && !defined(__ANDROID__) && !defined(CARES_USE_LIBRESOLV)
 static int config_domain(ares_channel channel, char *str)
 {
@@ -1877,7 +1893,7 @@ static const char *try_option(const char
   return ((size_t)(q - p) >= len && !strncmp(p, opt, len)) ? &p[len] : NULL;
 }
 
-#if !defined(WIN32) && !defined(WATT32) && \
+#if defined(__CYGWIN__) || !defined(WIN32) && !defined(WATT32) && \
     !defined(ANDROID) && !defined(__ANDROID__) && !defined(CARES_USE_LIBRESOLV)
 static char *try_config(char *s, const char *opt, char scc)
 {
--- origsrc/c-ares-1.12.0/ares_library_init.c	2016-03-13 10:29:16.000000000 -0500
+++ src/c-ares-1.12.0/ares_library_init.c	2017-06-18 14:22:48.186098700 -0500
@@ -23,9 +23,11 @@
 
 /* library-private global and unique instance vars */
 
-#ifdef USE_WINSOCK
+#if defined(WIN32) || defined(__CYGWIN__)
 fpGetNetworkParams_t ares_fpGetNetworkParams = ZERO_NULL;
 fpSystemFunction036_t ares_fpSystemFunction036 = ZERO_NULL;
+#endif
+#ifdef USE_WINSOCK
 fpGetAdaptersAddresses_t ares_fpGetAdaptersAddresses = ZERO_NULL;
 #endif
 
@@ -39,7 +41,7 @@ void *(*ares_malloc)(size_t size) = mall
 void *(*ares_realloc)(void *ptr, size_t size) = realloc;
 void (*ares_free)(void *ptr) = free;
 
-#ifdef USE_WINSOCK
+#if defined(WIN32) || defined(__CYGWIN__)
 static HMODULE hnd_iphlpapi;
 static HMODULE hnd_advapi32;
 #endif
@@ -47,7 +49,7 @@ static HMODULE hnd_advapi32;
 
 static int ares_win32_init(void)
 {
-#ifdef USE_WINSOCK
+#if defined(WIN32) || defined(__CYGWIN__)
 
   hnd_iphlpapi = 0;
   hnd_iphlpapi = LoadLibraryW(L"iphlpapi.dll");
@@ -62,6 +64,7 @@ static int ares_win32_init(void)
       return ARES_EADDRGETNETWORKPARAMS;
     }
 
+#ifdef USE_WINSOCK
   ares_fpGetAdaptersAddresses = (fpGetAdaptersAddresses_t)
     GetProcAddress(hnd_iphlpapi, "GetAdaptersAddresses");
   if (!ares_fpGetAdaptersAddresses)
@@ -70,6 +73,7 @@ static int ares_win32_init(void)
          think it should be an error, unless we don't want to
          support Windows 2000 anymore */
     }
+#endif
 
   /*
    * When advapi32.dll is unavailable or advapi32.dll has no SystemFunction036,
@@ -92,7 +96,7 @@ static int ares_win32_init(void)
 
 static void ares_win32_cleanup(void)
 {
-#ifdef USE_WINSOCK
+#if defined(WIN32) || defined(__CYGWIN__)
   if (hnd_advapi32)
     FreeLibrary(hnd_advapi32);
   if (hnd_iphlpapi)
--- origsrc/c-ares-1.12.0/ares_library_init.h	2016-01-23 16:41:55.000000000 -0600
+++ src/c-ares-1.12.0/ares_library_init.h	2017-06-18 14:23:14.811201400 -0500
@@ -20,21 +20,25 @@
 
 #include "ares_setup.h"
 
-#ifdef USE_WINSOCK
+#if defined(WIN32) || defined(__CYGWIN__)
 
 #include <iphlpapi.h>
 #include <ares_iphlpapi.h>
 
 typedef DWORD (WINAPI *fpGetNetworkParams_t) (FIXED_INFO*, DWORD*);
 typedef BOOLEAN (APIENTRY *fpSystemFunction036_t) (void*, ULONG);
+#ifdef USE_WINSOCK
 typedef ULONG (WINAPI *fpGetAdaptersAddresses_t) ( ULONG, ULONG, void*, IP_ADAPTER_ADDRESSES*, ULONG* );
+#endif
 
 /* Forward-declaration of variables defined in ares_library_init.c */
 /* that are global and unique instances for whole c-ares library.  */
 
 extern fpGetNetworkParams_t ares_fpGetNetworkParams;
 extern fpSystemFunction036_t ares_fpSystemFunction036;
+#ifdef USE_WINSOCK
 extern fpGetAdaptersAddresses_t ares_fpGetAdaptersAddresses;
+#endif
 
 #endif /* USE_WINSOCK */
 
--- origsrc/c-ares-1.12.0/ares_platform.c	2016-01-23 16:41:55.000000000 -0600
+++ src/c-ares-1.12.0/ares_platform.c	2017-06-18 14:20:26.857427400 -0500
@@ -23,7 +23,8 @@
 #include "ares_nowarn.h"
 #include "ares_private.h"
 
-#if defined(WIN32) && !defined(MSDOS)
+#if defined(WIN32) && !defined(MSDOS) || defined(__CYGWIN__)
+#include <windows.h>
 
 #define V_PLATFORM_WIN32s         0
 #define V_PLATFORM_WIN32_WINDOWS  1
--- origsrc/c-ares-1.12.0/ares_platform.h	2016-01-23 16:41:55.000000000 -0600
+++ src/c-ares-1.12.0/ares_platform.h	2017-06-18 14:12:09.027624000 -0500
@@ -20,7 +20,7 @@
 
 #include "ares_setup.h"
 
-#if defined(WIN32) && !defined(MSDOS)
+#if defined(WIN32) && !defined(MSDOS) || defined(__CYGWIN__)
 
 typedef enum {
   WIN_UNKNOWN,
--- origsrc/c-ares-1.12.0/ares_private.h	2016-02-11 05:23:52.000000000 -0600
+++ src/c-ares-1.12.0/ares_private.h	2017-06-18 14:09:27.214478500 -0500
@@ -50,7 +50,7 @@
 #define STATIC_TESTABLE static
 #endif
 
-#if defined(WIN32) && !defined(WATT32)
+#if defined(WIN32) && !defined(WATT32) || defined(__CYGWIN__)
 
 #define WIN_NS_9X      "System\\CurrentControlSet\\Services\\VxD\\MSTCP"
 #define WIN_NS_NT_KEY  "System\\CurrentControlSet\\Services\\Tcpip\\Parameters"
@@ -59,7 +59,9 @@
 #define DATABASEPATH   "DatabasePath"
 #define WIN_PATH_HOSTS  "\\hosts"
 
-#elif defined(WATT32)
+#endif
+
+#if defined(WATT32)
 
 #define PATH_RESOLV_CONF "/dev/ENV/etc/resolv.conf"
 
